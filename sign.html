<html>
    <head>
        <title>sign</title>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <link href="stylesheets/screen.css" media="all" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Quattrocento' rel='stylesheet' type='text/css'>

        <!-- Bootstrap - Javascript(?)-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script type="text/javascript" src="js/bootstrap/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" /> 

        <!-- Loading Bootstrap -->
        <!-- <link href="dist/css/vendor/bootstrap.min.css" rel="stylesheet"> -->

        <!-- Loading Flat UI -->
        <link href="dist/css/flat-ui.css" rel="stylesheet">
        <link href="docs/assets/css/demo.css" rel="stylesheet">
        <link rel="shortcut icon" href="img/favicon.ico">

        <!-- Todo-parse Javascript -->
        
        <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
        <script src="http://www.parsecdn.com/js/parse-1.2.13.min.js"></script>
        
        <!--//JavaScript寫在這裡-->
        <script type="text/javascript">             
            Parse.initialize("19BDOaHH86XPBfrBbpr4skyC0efMHQQKRdYi2Dzt","zFnzw3ICGaSB9dVxHWr9tOTRzn15v79DU3l5Sv5Y");
                        
            //判斷密碼是否一樣           
            function check(){ 
                var username = e1.value;
                var password = p1.value;
                
                if(p1.value==p2.value){   //密碼一樣就會去跑signUpToParse
                    signUpToParse();
                    return true;  
                }
                else{           //不一樣就會顯示錯誤
                    document.getElementById("pw").innerHTML="密碼不相符，請重新輸入";
                    p1.value="";
                    p2.value="";
                }  
            }
            
            //判斷帳號是否重複           
            function signUpToParse() {
                var username = e1.value;
                var password = p1.value;
                var password2 = p2.value;
                
                Parse.User.signUp(username, password, null, {  //去撈資料庫的資料核對是否有重複
                    success: function(user) {
                        window.location.href="main.html";   
                    },

                    error: function(user, error) {  //有重複顯示錯誤
                        document.getElementById("email-auth-no").innerHTML="帳號已有人使用，請重新輸入!";
                        e1.value="";
                        p1.value="";
                        p2.value="";
                    }
                });
            }
            //密碼錯誤通知顯示消失
            function email(){
                document.getElementById("email-auth-no").innerHTML="";
                document.getElementById("pw").innerHTML="";
            }
            // 帳號即時檢查
            function timelyEmail(inputField,helpText){
            var User = Parse.Object.extend("User");
            var query = new Parse.Query(User);
            
            query.notEqualTo("User", "username");
            query.find({
                success: function(results) {
                
                    for (var i = 0; i < results.length; i++) {
                       
                        var object = results[i];
                        // alert(object.id + ' - ' + object.get('username'));
                        var username =  object.get('username');
                        if (object) {
                            if(inputField.value == username){
                               (helpText !=null)
                                helpText.innerHTML = "已有人使用此帳號!";
                                return false;
                            }
                        
                        }
                    
                    }
                    
                
                    document.getElementById("email_help").innerHTML="";
                },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
              }

            });
            }
        </script>
    </head>
    
    <body >
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
          註冊
        </button>

        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <!-- <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
              </div> -->
              <div class="modal-body">
                <form action="new-story_submit" method="get" accept-charset="utf-8">
                            <p>
                                <!-- <label>選擇圖片</label>  -->
                                <input type="file" id="profilePhotoFileUpload" /> 
                            </p>
                            <div id="result"></div>
                                
                        </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary">設成大頭照</button>
              </div>
            </div>
          </div>
        </div>
        <div class="navigation">
            <div class="navigation2">
                <div class="signmember">
                    <h1>註冊會員</h1>
                    <form class="forma">
                        <h6><label>Email</label><input type="text" name="fname" id="e1" onblur="timelyEmail(this,document.getElementById('email_help'));" /></h6>
                        <span id="email_help" class="help"></span>
                        <h6><label>密　碼</label><input type="password" name="lname" id="p1" placeholder="" onclick="email()"/></h6>
                        <h6><label>確認密碼</label><input type="password" name="lname" id="p2" placeholder="" onclick="email()"/></h6>
                    </form>
                    <div class="bn-sign">
                        <a  class="btn btn-block btn-lg btn-danger" onclick="check()">註冊</a>
                    </div>  
                    <p><span id="pw"></span></p>  <!--密碼錯誤在這裡顯示-->
                    <p><span id="email-auth-no"></span></p>   <!--帳號錯誤在這裡顯示-->
                </div>
            </div>
        </div>
        


        <!-- 上傳圖片顯示 -->
    <script type="text/javascript">
      var result = document.getElementById("result"); 
      var input = document.getElementById("profilePhotoFileUpload"); 
      if(typeof FileReader==='undefined'){ 
         
          input.setAttribute('disabled','disabled'); 
      }else{ 
          input.addEventListener('change',readFile,false); 
      } 
      function readFile(){ 
          var file = this.files[0]; 
          if(!/image\/\w+/.test(file.type)){ 
              alert("檔案錯了喔><"); 
              return false; 
          } 
          var reader = new FileReader(); 
          reader.readAsDataURL(file); 

          reader.onload = function(e){ 
              result.innerHTML = '<img src="'+this.result+'" alt=""/>' 
          } 

      } 
    </script>
    </body>
</html>